<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Bridge Listener</title>
  <script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>
</head>
<body>
  <h2>Listening Bridge Active</h2>

  <script>
    const APP_ID = "9561383D-4BC2-F4F1-FF73-B529BFE77000";
    const API_KEY = "BEE4A193-7ADC-419B-9EB4-202FDA99ACC6";

    // Handle incoming setup message from Thunkable Web Bridge
    window.addEventListener("message", async (event) => {
      console.log("📩 Received setup message:", event.data);

      let data;
      try {
        data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
      } catch (e) {
        console.error("❌ Invalid JSON:", e.message);
        return;
      }

      const { token, channelName } = data;

      if (!token || !channelName) {
        console.warn("❌ Missing token or channelName");
        return;
      }

      Backendless.initApp(APP_ID, API_KEY);
      Backendless.UserService.setCurrentUserToken(token);

      try {
        const channel = Backendless.Messaging.subscribe(channelName);
        channel.addMessageListener((message) => {
          const msg = typeof message === "object" ? JSON.stringify(message) : String(message);
          console.log("📤 Broadcasting to Thunkable Web Bridge:", msg);

          // ✅ Thunkable JS Web Bridge uses this for both iOS and Android
          window.postMessage(msg, "*");
        });

        console.log("✅ Subscribed to:", channelName);
      } catch (e) {
        console.error("❌ Subscription error:", e.message);
      }
    });

    console.log("📡 Web Bridge script ready");
  </script>
</body>
</html>
