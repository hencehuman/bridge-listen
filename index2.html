<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Bridge Listener</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; connect-src *; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>
</head>
<body>
  <h2>Listening Bridge Active</h2>

  <script>
    const APP_ID = "9561383D-4BC2-F4F1-FF73-B529BFE77000";
    const API_KEY = "BEE4A193-7ADC-419B-9EB4-202FDA99ACC6";
    let isSending = false; // Prevent send loops
    let isWebViewReady = false; // Track WebView readiness
    let hasSubscribed = false; // Prevent subscription attempts

    function isWebView() {
      const ua = navigator.userAgent.toLowerCase();
      return /android|iphone|ipad|mobile|webview/i.test(ua) && !/chrome|firefox|safari|edge/i.test(ua);
    }

    function sendMessage(message) {
      if (isSending) {
        console.warn("âš ï¸ Send skipped: Previous send in progress");
        return;
      }
      isSending = true;
      const msgText = typeof message === "object" ? JSON.stringify(message) : String(message);
      console.log("ðŸ“¤ Sending:", msgText);
      try {
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(msgText);
          console.log("ðŸ“¤ Sent via ReactNativeWebView");
        } else {
          window.postMessage(msgText, "*");
          console.log("ðŸ“¤ SENT via window.postMessage");
        }
      } catch (e) {
        console.error("âŒ Failed to send:", e.message);
        console.log("ðŸ” Debug: ReactNativeWebView:", !!window.ReactNativeWebView, "WebView Env:", navigator.userAgent);
        if (!isWebView()) {
          console.warn("âš ï¸ Non-WebView environment, suppressing errors");
        }
      } finally {
        isSending = false;
      }
    }

    function checkWebViewReadiness(callback) {
      const maxAttempts = 5;
      let attempts = 0;

      function poll() {
        if (window.ReactNativeWebView || attempts >= maxAttempts) {
          isWebViewReady = true;
          console.log("âœ… WebView ready:", !!window.ReactNativeWebView);
          sendMessage({ status: "ready", message: "WebView initialized" });
          callback();
        } else {
          attempts++;
          console.log("ðŸ› ï¸ Polling WebView, attempt:", attempts);
          setTimeout(poll, 1000);
        }
      }

      poll();
    }

    function initializeBridge() {
      console.log("ðŸ› ï¸ Initializing WebBridge...");
      if (isWebView()) {
        sendMessage({ status: "init", message: "Bridge initializing" });
        checkWebViewReadiness(() => {});
      } else {
        console.warn("âš ï¸ Non-WebView environment, skipping initialization");
      }
    }

    async function subscribeToChannel(token, channelName) {
      if (hasSubscribed) {
        console.warn("âš ï¸ Subscription already attempted, skipping");
        return;
      }
      hasSubscribed = true;

      if (!token || !channelName) {
        console.warn("âŒ Missing token or channelName");
        sendMessage({ status: "error", message: "Missing token or channelName" });
        return;
      }

      try {
        Backendless.initApp(APP_ID, API_KEY);
        Backendless.UserService.setCurrentUserToken(token);
        const channel = Backendless.Messaging.subscribe(channelName);
        channel.addMessageListener((message) => {
          console.log("ðŸ“¤ Forwarding message:", message);
          sendMessage(message);
        });
        console.log("âœ… Subscribed to:", channelName);
        sendMessage({ status: "success", message: `Listening on ${channelName}` });
      } catch (e) {
        console.error("âŒ Subscription error:", e.message);
        sendMessage({ status: "error", message: e.message });
      }
    }

    window.addEventListener("message", async (event) => {
      if (!isWebView()) {
        console.warn("âš ï¸ Non-WebView environment, ignoring message:", event.data);
        return;
      }

      console.log("ðŸ“© Received message:", event.data);
      let data;

      try {
        data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
      } catch (e) {
        console.error("âŒ Failed to parse JSON:", e.message);
        sendMessage({ status: "error", message: "Invalid JSON format" });
        return;
      }

      if (data.action === "testBridge") {
        console.log("ðŸ› ï¸ Bridge test: Script loaded");
        sendMessage("BridgeReady");
        return;
      }

      if (!isWebViewReady) {
        console.warn("âš ï¸ WebView not ready, delaying subscription");
        checkWebViewReadiness(() => subscribeToChannel(data.token, data.channelName));
      } else {
        subscribeToChannel(data.token, data.channelName);
      }
    }, { passive: true });

    initializeBridge();
    console.log("ðŸ“¡ WebBridge ready");
  </script>
</body>
</html>
